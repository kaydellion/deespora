<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>View Listing</title>

<!--favicon-->
<link rel="icon" type="image/png" href="img/favicon.png" />

<!-- Bootstrap 5 CSS -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

<!-- Bootstrap Icons -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">

<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">

<!-- Main CSS -->
<link rel="stylesheet" href="css/style.css" type="text/css" />
</head>
<body>

<!-- Add auth check -->
<script src="config.js"></script>
<script>checkAuth();</script>

<!-- Header -->
<div class="header-wrap">
  <nav class="top-pill navbar navbar-dark">
    <div class="d-flex align-items-center w-100 justify-content-between">
      
      <!-- Toggle for sm/md -->
      <div class="dropdown d-lg-none">
        <button class="navbar-toggler" type="button" data-bs-toggle="dropdown" aria-expanded="false">
          <span class="navbar-toggler-icon"></span>
        </button>
        <!-- Mobile Dropdown -->
        <ul class="dropdown-menu mobile-menu border-0 shadow mt-2">
          <li><a class="dropdown-item" href="dashboard.html">Dashboard</a></li>
          <li><a class="dropdown-item" href="users.html">Users</a></li>
          <li><a class="dropdown-item" href="categories.html">Categories</a></li>
          <li><a class="dropdown-item" href="listing.html">Listings</a></li>
          <li><a class="dropdown-item" href="#">Settings</a></li>
        </ul>
      </div>

      <!-- Desktop Nav -->
      <ul class="navbar-nav flex-row d-none d-lg-flex gap-2">
        <li class="nav-item"><a class="nav-link" href="dashboard.html">Dashboard</a></li>
        <li class="nav-item"><a class="nav-link" href="users.html">Users</a></li>
        <li class="nav-item"><a class="nav-link" href="categories.html">Categories</a></li>
        <li class="nav-item"><a class="nav-link active" href="listing.html">Listings</a></li>
        <li class="nav-item"><a class="nav-link" href="#">Settings</a></li>
      </ul>

      <!-- Icons -->
      <div class="pill-icons gap-2">
        <button class="icon-circle" aria-label="Notifications"><i class="bi bi-bell-fill"></i></button>
        <button class="btn btn-sm btn-outline-light" onclick="logout()">Logout</button>
        <img src="img/avatar-placeholder.png" alt="admin avatar" class="avatar-sm" />
      </div>
    </div>
  </nav>
</div>

<!-- Main Content -->
<div class="container mt-4">
    
    <!-- Back Button -->
    <div class="mb-3">
        <a href="listing.html" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-left"></i> Back to Listings
        </a>
    </div>

    <!-- Loading Spinner -->
    <div id="loadingSpinner" class="text-center py-5">
        <div class="spinner-border" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>

    <!-- Listing Details -->
    <div id="listingDetails" class="d-none">
        <div class="card shadow-sm mb-3">
            <div class="card-body p-4">
                <h2 id="listingTitle" class="mb-3">Loading...</h2>
                
                <div class="row">
                    <div class="col-md-6">
                        <p><strong>Category:</strong> <span id="listingCategory">-</span></p>
                        <p><strong>Location:</strong> <span id="listingLocation">-</span></p>
                        <p><strong>Date:</strong> <span id="listingDate">-</span></p>
                        <p><strong>Status:</strong> <span id="listingStatus" class="badge bg-success">-</span></p>
                    </div>
                    
                    <div class="col-md-6">
                        <p><strong>Price:</strong> <span id="listingPrice">-</span></p>
                        <p><strong>Contact:</strong> <span id="listingContact">-</span></p>
                        <p><strong>Created:</strong> <span id="listingCreated">-</span></p>
                    </div>
                </div>
                
                <hr>
                
                <div class="mt-3">
                    <h5>Description</h5>
                    <p id="listingDescription">No description available.</p>
                </div>
            </div>
        </div>

        <!-- Additional Details Sections -->
        <div class="row g-3">
            <!-- Venue Information -->
            <div class="col-md-6" id="venueSection" style="display: none;">
                <div class="card shadow-sm h-100">
                    <div class="card-header bg-light">
                        <h5 class="mb-0"><i class="bi bi-building me-2"></i>Venue Information</h5>
                    </div>
                    <div class="card-body">
                        <p><strong>Venue Name:</strong> <span id="venueName">-</span></p>
                        <p><strong>Address:</strong> <span id="venueAddress">-</span></p>
                        <p><strong>City, State:</strong> <span id="venueCityState">-</span></p>
                        <p><strong>Postal Code:</strong> <span id="venuePostal">-</span></p>
                        <p><strong>Country:</strong> <span id="venueCountry">-</span></p>
                        <p class="mb-0"><strong>Timezone:</strong> <span id="venueTimezone">-</span></p>
                    </div>
                </div>
            </div>

            <!-- Sales Information -->
            <div class="col-md-6" id="salesSection" style="display: none;">
                <div class="card shadow-sm h-100">
                    <div class="card-header bg-light">
                        <h5 class="mb-0"><i class="bi bi-ticket-perforated me-2"></i>Sales Information</h5>
                    </div>
                    <div class="card-body">
                        <h6>Public Sales:</h6>
                        <p><strong>Start:</strong> <span id="salesStart">-</span></p>
                        <p><strong>End:</strong> <span id="salesEnd">-</span></p>
                        <div id="presalesInfo"></div>
                    </div>
                </div>
            </div>

            <!-- Event Classifications -->
            <div class="col-md-6" id="classificationSection" style="display: none;">
                <div class="card shadow-sm h-100">
                    <div class="card-header bg-light">
                        <h5 class="mb-0"><i class="bi bi-tags me-2"></i>Classifications</h5>
                    </div>
                    <div class="card-body" id="classificationsContent">
                    </div>
                </div>
            </div>

            <!-- Parking & Accessibility -->
            <div class="col-md-6" id="accessSection" style="display: none;">
                <div class="card shadow-sm h-100">
                    <div class="card-header bg-light">
                        <h5 class="mb-0"><i class="bi bi-info-circle me-2"></i>Additional Information</h5>
                    </div>
                    <div class="card-body">
                        <div id="parkingInfo" style="display: none;">
                            <h6>Parking:</h6>
                            <p id="parkingDetail" class="small">-</p>
                        </div>
                        <div id="accessibilityInfo" style="display: none;">
                            <h6>Accessibility:</h6>
                            <p id="accessibilityDetail" class="small">-</p>
                        </div>
                        <div id="boxOfficeInfo" style="display: none;">
                            <h6>Box Office:</h6>
                            <p id="boxOfficeDetail" class="small">-</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Raw JSON Data (Collapsible) -->
        <div class="card shadow-sm mt-3">
            <div class="card-body">
                <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="collapse" data-bs-target="#rawJsonData">
                    <i class="bi bi-code-square me-1"></i> View Raw Data (Technical)
                </button>
                <div class="collapse mt-3" id="rawJsonData">
                    <pre id="listingJson" class="bg-light p-3 rounded" style="max-height: 400px; overflow-y: auto; font-size: 0.85rem;"></pre>
                </div>
            </div>
        </div>
    </div>

    <!-- Error Message -->
    <div id="errorMessage" class="alert alert-danger d-none"></div>
</div>

<!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="config.js"></script>
<script src="api.js"></script>
<script>
// Get listing ID from URL
const urlParams = new URLSearchParams(window.location.search);
const listingId = urlParams.get('id');
const listingName = urlParams.get('name') ? decodeURIComponent(urlParams.get('name')) : null;
let listingType = urlParams.get('type') || 'all-events';

// Normalize type - convert 'events' to 'all-events'
if (listingType === 'events') {
    listingType = 'all-events';
}

// Get friendly category name from API type
function getCategoryDisplayName(type) {
    const categoryNames = {
        'all-events': 'Events',
        'events': 'Events',
        'restaurants': 'Restaurants',
        'catering': 'Catering',
        'real-estate': 'Real Estate',
        'realestate': 'Real Estate'
    };
    
    return categoryNames[type] || 'Events';
}

// Load listing details
async function loadListingDetails() {
    if (!listingId) {
        showError('No listing ID provided');
        return;
    }
    
    try {
        console.log('Searching for listing ID:', listingId, 'Name:', listingName, 'in type:', listingType);
        
        // If type is 'all', we need to search across all categories
        if (listingType === 'all') {
            const categoryTypes = ['all-events', 'restaurants', 'catering', 'real-estate'];
            
            for (const categoryType of categoryTypes) {
                console.log('Searching in category:', categoryType);
                const listings = await API.getListings(categoryType);
                
                if (listings && listings.length > 0) {
                    // Try to find by ID first
                    let listing = listings.find(item => {
                        const itemId = (item.id || item._id || '').toString();
                        return itemId === listingId || itemId === listingId.toString();
                    });
                    
                    // If not found by ID and we have a name, try searching by name
                    if (!listing && listingName) {
                        listing = listings.find(item => {
                            const itemName = (item.title || item.name || '').toLowerCase();
                            return itemName === listingName.toLowerCase();
                        });
                    }
                    
                    // If still not found, try by index (if ID is a number)
                    if (!listing && !isNaN(listingId)) {
                        const index = parseInt(listingId);
                        if (index >= 0 && index < listings.length) {
                            listing = listings[index];
                        }
                    }
                    
                    if (listing) {
                        console.log('Found listing in category:', categoryType);
                        // Update the listingType to the correct category for display
                        listingType = categoryType;
                        displayListing(listing);
                        return;
                    }
                }
            }
            
            // If we get here, listing wasn't found in any category
            console.error('Listing not found. ID:', listingId, 'Name:', listingName);
            showError('Listing not found in any category. Please try again from the listings page.');
            return;
        }
        
        // Normal flow for specific category type
        const allListings = await API.getListings(listingType);
        console.log('Fetched listings:', allListings);
        
        if (!allListings || allListings.length === 0) {
            showError('No listings found in this category');
            return;
        }
        
        // Find the listing by ID
        let listing = allListings.find(item => {
            const itemId = (item.id || item._id || '').toString();
            return itemId === listingId || itemId === listingId.toString();
        });
        
        // Try by name if ID search fails
        if (!listing && listingName) {
            listing = allListings.find(item => {
                const itemName = (item.title || item.name || '').toLowerCase();
                return itemName === listingName.toLowerCase();
            });
        }
        
        // Try by index as last resort
        if (!listing && !isNaN(listingId)) {
            const index = parseInt(listingId);
            if (index >= 0 && index < allListings.length) {
                listing = allListings[index];
            }
        }
        
        if (!listing) {
            console.error('Listing not found with ID:', listingId, 'Name:', listingName);
            console.log('Available IDs:', allListings.map(l => l.id || l._id));
            showError('Listing not found in this category');
            return;
        }
        
        displayListing(listing);
        
    } catch (error) {
        console.error('Error loading listing:', error);
        showError('Failed to load listing details: ' + error.message);
    }
}

// Display listing details
function displayListing(listing) {
    document.getElementById('loadingSpinner').classList.add('d-none');
    document.getElementById('listingDetails').classList.remove('d-none');
    
    // Extract data from complex structure
    const title = listing.title || listing.name || 'Untitled';
    const category = getCategoryDisplayName(listingType);
    
    // Extract location from embedded venues
    const venue = listing._embedded?.venues?.[0];
    const venueName = venue?.name || '';
    const city = venue?.city?.name || listing.city || '';
    const state = venue?.state?.stateCode || listing.state || '';
    const address = venue?.address?.line1 || '';
    const location = [venueName, address, city, state].filter(Boolean).join(', ') || '-';
    
    // Extract dates
    const startDate = listing.dates?.start?.localDate || listing.date;
    const startTime = listing.dates?.start?.localTime;
    const endDate = listing.dates?.end?.localDate;
    const timezone = listing.dates?.timezone || '';
    const dateDisplay = formatDateFull(startDate, startTime, timezone);
    
    // Status
    const statusCode = listing.dates?.status?.code || listing.status || '-';
    const status = statusCode === 'onsale' ? 'On Sale' : 
                  statusCode === 'offsale' ? 'Off Sale' : 
                  statusCode === 'cancelled' ? 'Cancelled' : statusCode;
    
    // Images
    const images = listing.images || [];
    const primaryImage = images.find(img => img.ratio === '16_9' && img.width >= 640) || images[0];
    
    // Price - handle different formats
    let priceDisplay = '-';
    if (listing.priceRanges && listing.priceRanges.length > 0) {
        const priceRange = listing.priceRanges[0];
        if (priceRange.min !== undefined && priceRange.max !== undefined) {
            priceDisplay = `$${priceRange.min} - $${priceRange.max} ${priceRange.currency || 'USD'}`;
        } else if (priceRange.min !== undefined) {
            priceDisplay = `From $${priceRange.min} ${priceRange.currency || 'USD'}`;
        }
    } else if (listing.price) {
        priceDisplay = `$${listing.price}`;
    }
    
    // Contact - try multiple fields
    const contact = listing.url || 
                   listing.contact || 
                   listing.phone || 
                   listing.email || 
                   (venue?.boxOfficeInfo?.phoneNumberDetail ? venue.boxOfficeInfo.phoneNumberDetail : '') ||
                   '-';
    
    // Created date - try multiple fields
    const createdDate = listing.createdAt || 
                       listing.created || 
                       listing.onsaleStartDateTime ||
                       listing.dates?.start?.dateTime ||
                       '-';
    
    // Update main UI
    document.getElementById('listingTitle').textContent = title;
    document.getElementById('listingCategory').textContent = category;
    document.getElementById('listingLocation').textContent = location;
    document.getElementById('listingDate').textContent = dateDisplay;
    document.getElementById('listingStatus').textContent = status;
    document.getElementById('listingPrice').textContent = priceDisplay;
    document.getElementById('listingContact').textContent = contact;
    document.getElementById('listingCreated').textContent = createdDate !== '-' ? formatDateFull(createdDate) : '-';
    document.getElementById('listingDescription').textContent = listing.description || listing.info || listing.pleaseNote || 'No description available.';
    
    // Add image if available
    const cardBody = document.querySelector('#listingDetails .card-body');
    if (primaryImage && cardBody) {
        const existingImage = cardBody.querySelector('img');
        if (!existingImage) {
            const imageHtml = `<img src="${primaryImage.url}" class="img-fluid rounded mb-3" alt="${title}" style="max-width: 100%; height: auto;">`;
            cardBody.insertAdjacentHTML('afterbegin', imageHtml);
        }
    }
    
    // Populate venue information
    if (venue) {
        document.getElementById('venueName').textContent = venue.name || '-';
        document.getElementById('venueAddress').textContent = venue.address?.line1 || '-';
        document.getElementById('venueCityState').textContent = `${venue.city?.name || '-'}, ${venue.state?.stateCode || '-'}`;
        document.getElementById('venuePostal').textContent = venue.postalCode || '-';
        document.getElementById('venueCountry').textContent = venue.country?.name || '-';
        document.getElementById('venueTimezone').textContent = venue.timezone || '-';
        document.getElementById('venueSection').style.display = 'block';
        
        // Box office info
        if (venue.boxOfficeInfo) {
            if (venue.boxOfficeInfo.phoneNumberDetail) {
                document.getElementById('boxOfficeDetail').textContent = venue.boxOfficeInfo.phoneNumberDetail;
                document.getElementById('boxOfficeInfo').style.display = 'block';
            }
            if (venue.boxOfficeInfo.openHoursDetail) {
                const hours = document.createElement('p');
                hours.className = 'small';
                hours.innerHTML = '<strong>Hours:</strong> ' + venue.boxOfficeInfo.openHoursDetail;
                document.getElementById('boxOfficeInfo').appendChild(hours);
            }
        }
        
        // Parking info
        if (venue.parkingDetail) {
            document.getElementById('parkingDetail').textContent = venue.parkingDetail.substring(0, 300) + '...';
            document.getElementById('parkingInfo').style.display = 'block';
        }
        
        // Accessibility
        if (venue.accessibleSeatingDetail) {
            document.getElementById('accessibilityDetail').textContent = venue.accessibleSeatingDetail;
            document.getElementById('accessibilityInfo').style.display = 'block';
        }
        
        if (document.getElementById('parkingInfo').style.display === 'block' || 
            document.getElementById('accessibilityInfo').style.display === 'block' ||
            document.getElementById('boxOfficeInfo').style.display === 'block') {
            document.getElementById('accessSection').style.display = 'block';
        }
    }
    
    // Populate sales information
    if (listing.sales) {
        const sales = listing.sales;
        if (sales.public) {
            document.getElementById('salesStart').textContent = formatDateFull(sales.public.startDateTime) || '-';
            document.getElementById('salesEnd').textContent = formatDateFull(sales.public.endDateTime) || '-';
        }
        
        if (sales.presales && sales.presales.length > 0) {
            let presalesHtml = '<h6 class="mt-3">Presales:</h6><ul class="small">';
            sales.presales.forEach(presale => {
                presalesHtml += `<li><strong>${presale.name}:</strong> ${formatDateFull(presale.startDateTime)} - ${formatDateFull(presale.endDateTime)}</li>`;
            });
            presalesHtml += '</ul>';
            document.getElementById('presalesInfo').innerHTML = presalesHtml;
        }
        
        document.getElementById('salesSection').style.display = 'block';
    }
    
    // Populate classifications
    if (listing.classifications && listing.classifications.length > 0) {
        let classificationsHtml = '';
        listing.classifications.forEach((classification, index) => {
            if (index > 0) classificationsHtml += '<hr class="my-2">';
            if (classification.segment?.name) {
                classificationsHtml += `<p class="mb-1"><strong>Segment:</strong> ${classification.segment.name}</p>`;
            }
            if (classification.genre?.name) {
                classificationsHtml += `<p class="mb-1"><strong>Genre:</strong> ${classification.genre.name}</p>`;
            }
            if (classification.subGenre?.name) {
                classificationsHtml += `<p class="mb-1"><strong>Sub-Genre:</strong> ${classification.subGenre.name}</p>`;
            }
            if (classification.type?.name) {
                classificationsHtml += `<p class="mb-1"><strong>Type:</strong> ${classification.type.name}</p>`;
            }
        });
        document.getElementById('classificationsContent').innerHTML = classificationsHtml;
        document.getElementById('classificationSection').style.display = 'block';
    }
    
    // Raw JSON
    document.getElementById('listingJson').textContent = JSON.stringify(listing, null, 2);
}

// Format date with full details
function formatDateFull(dateString, timeString, timezone) {
    if (!dateString) return '-';
    
    try {
        const date = new Date(dateString);
        let formatted = date.toLocaleDateString('en-US', { 
            year: 'numeric', 
            month: 'long', 
            day: 'numeric'
        });
        
        if (timeString) {
            formatted += ' at ' + timeString;
        }
        
        if (timezone) {
            formatted += ' (' + timezone + ')';
        }
        
        return formatted;
    } catch (e) {
        return dateString;
    }
}

// Show error
function showError(message) {
    document.getElementById('loadingSpinner').classList.add('d-none');
    document.getElementById('errorMessage').textContent = message;
    document.getElementById('errorMessage').classList.remove('d-none');
}

// Format date
function formatDate(dateString) {
    if (!dateString) return '-';
    
    try {
        const date = new Date(dateString);
        return date.toLocaleDateString('en-US', { 
            year: 'numeric', 
            month: 'long', 
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
        });
    } catch (e) {
        return dateString;
    }
}

// Load on page load
document.addEventListener('DOMContentLoaded', loadListingDetails);
</script>

</body>
</html>
